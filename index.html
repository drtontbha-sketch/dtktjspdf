<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ™ºèƒ½æŠ¤çœ¼é˜…è¯»å™¨</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes loading-bar {
      0% { width: 0%; }
      100% { width: 100%; }
    }
    
    .animate-fade-in {
      animation: fade-in 0.8s ease-out forwards;
      opacity: 0;
    }
    
    .animate-loading-bar {
      animation: loading-bar 3s ease-out forwards;
    }
    
    .animate-ping {
      animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
    }
    
    @keyframes ping {
      75%, 100% {
        transform: scale(2);
        opacity: 0;
      }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900 transition-colors duration-300">
  <!-- Splash Screen -->
  <div id="splashScreen" class="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 flex items-center justify-center relative overflow-hidden hidden">
    <div class="absolute inset-0">
      <div id="splashDots"></div>
    </div>
    <div class="text-center z-10 px-8">
      <div class="relative mb-8">
        <div class="w-32 h-32 mx-auto relative">
          <div class="absolute inset-0 rounded-full border-4 border-blue-400/30 animate-spin"></div>
          <div class="absolute inset-2 rounded-full border-4 border-purple-400/30 animate-spin" style="animation-direction: reverse;"></div>
          <div class="absolute inset-0 flex items-center justify-center">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-400 to-purple-500 rounded-2xl flex items-center justify-center shadow-2xl transform animate-pulse">
              <i data-lucide="book" class="w-10 h-10 text-white"></i>
            </div>
          </div>
          <div class="absolute -top-2 -right-2 animate-bounce">
            <i data-lucide="sparkles" class="w-6 h-6 text-yellow-400"></i>
          </div>
          <div class="absolute -bottom-2 -left-2 animate-bounce" style="animation-delay: 0.5s;">
            <i data-lucide="heart" class="w-6 h-6 text-pink-400"></i>
          </div>
        </div>
      </div>
      <h1 class="text-5xl font-bold text-white mb-4 animate-fade-in">
        <span class="bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
          æ™ºèƒ½æŠ¤çœ¼é˜…è¯»å™¨
        </span>
      </h1>
      <p class="text-xl text-blue-200/80 mb-8 animate-fade-in" style="animation-delay: 0.5s;">
        è®©é˜…è¯»æˆä¸ºä¸€ç§å¥åº·çš„äº«å—
      </p>
      <div class="flex flex-wrap justify-center gap-3 mb-8 animate-fade-in" style="animation-delay: 1s;">
        <span class="px-4 py-2 bg-white/10 backdrop-blur-md rounded-full text-white/90 text-sm border border-white/20">ğŸ“š å¤šæ ¼å¼æ”¯æŒ</span>
        <span class="px-4 py-2 bg-white/10 backdrop-blur-md rounded-full text-white/90 text-sm border border-white/20">ğŸ‘ï¸ æ™ºèƒ½æŠ¤çœ¼</span>
        <span class="px-4 py-2 bg-white/10 backdrop-blur-md rounded-full text-white/90 text-sm border border-white/20">ğŸ”– æ™ºèƒ½ä¹¦ç­¾</span>
        <span class="px-4 py-2 bg-white/10 backdrop-blur-md rounded-full text-white/90 text-sm border border-white/20">â° ä¼‘æ¯æé†’</span>
      </div>
      <div class="flex items-center justify-center space-x-2 animate-fade-in" style="animation-delay: 1.5s;">
        <i data-lucide="eye" class="w-5 h-5 text-green-400 animate-pulse"></i>
        <span class="text-blue-200/70">æ­£åœ¨ä¸ºæ‚¨å‡†å¤‡æœ€ä½³æŠ¤çœ¼é˜…è¯»ä½“éªŒ...</span>
      </div>
      <div class="w-64 mx-auto mt-6 animate-fade-in" style="animation-delay: 2s;">
        <div class="h-1 bg-white/20 rounded-full overflow-hidden">
          <div class="h-full bg-gradient-to-r from-blue-400 to-purple-500 rounded-full animate-loading-bar"></div>
        </div>
      </div>
      <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-white/50 text-sm animate-fade-in" style="animation-delay: 2.5s;">
        Made with â¤ï¸ for healthy reading
      </div>
    </div>
  </div>

  <!-- Break Reminder Modal -->
  <div id="breakReminderModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-md mx-4 text-center">
      <div class="w-16 h-16 mx-auto mb-4 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
        <i data-lucide="eye" class="w-8 h-8 text-blue-600"></i>
      </div>
      <h3 class="text-xl font-bold mb-2">æŠ¤çœ¼æé†’</h3>
      <p id="breakReminderText" class="text-gray-600 dark:text-gray-300 mb-6"></p>
      <div class="flex space-x-3">
        <button id="acknowledgeBreak" class="flex-1 bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">æˆ‘çŸ¥é“äº†</button>
        <button id="disableBreakReminder" class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 py-2 px-4 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">å…³é—­æé†’</button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden">
    <!-- Top Navigation Bar -->
    <div id="topNav" class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-0 z-10"></div>

    <!-- Reading Progress Bar -->
    <div id="progressBar" class="bg-white px-4 py-2 border-b border-gray-200 hidden">
      <div class="flex items-center justify-between text-sm mb-1">
        <span>é˜…è¯»è¿›åº¦</span>
        <span id="progressPercent">0%</span>
      </div>
      <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
        <div id="progressFill" class="h-full bg-blue-500 transition-all duration-300 ease-out" style="width: 0%"></div>
      </div>
    </div>

    <!-- Side Menu -->
    <div id="sideMenu" class="fixed inset-0 z-20 hidden">
      <div class="absolute inset-0 bg-black bg-opacity-50" id="menuOverlay"></div>
      <div class="absolute right-0 top-0 h-full w-80 bg-white shadow-lg transform transition-transform duration-300">
        <div class="p-4 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="font-medium">èœå•</h3>
            <button id="closeMenu"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
          </div>
        </div>
        <div id="menuContent" class="p-4 space-y-4"></div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="fixed inset-0 z-20 hidden">
      <div class="absolute inset-0 bg-black bg-opacity-50" id="settingsOverlay"></div>
      <div class="absolute right-0 top-0 h-full w-80 bg-white shadow-lg transform transition-transform duration-300 overflow-y-auto">
        <div class="p-4 border-b border-gray-200">
          <div class="flex items-center justify-between">
            <h3 class="font-medium">è®¾ç½®</h3>
            <button id="closeSettings"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
          </div>
        </div>
        <div id="settingsContent" class="p-4 space-y-6"></div>
      </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="flex-1"></div>

    <!-- File Input -->
    <input id="fileInput" type="file" accept=".txt,.md,.json,.rtf" class="hidden">
  </div>

  <script>
    // State
    let showSplash = true;
    let content = '';
    let fileName = '';
    let fontSize = 16;
    let lineHeight = 1.6;
    let isDarkMode = false;
    let showSettings = false;
    let showMenu = false;
    let readingProgress = 0;
    let bookmarks = [];
    let currentPosition = 0;
    let font = 'system';
    let eyeCareMode = false;
    let autoBreakReminder = false;
    let readingTime = 0;
    let breakInterval = 20;
    let showBreakReminder = false;
    let eyeCareIntensity = 50;
    let backgroundTint = 'sepia';
    let readingTimer = null;

    // Font Options
    const fontOptions = [
      { value: 'system', label: 'ç³»ç»Ÿé»˜è®¤' },
      { value: 'serif', label: 'è¡¬çº¿å­—ä½“' },
      { value: 'sans-serif', label: 'æ— è¡¬çº¿å­—ä½“' },
      { value: 'monospace', label: 'ç­‰å®½å­—ä½“' }
    ];

    // Eye Care Themes
    const eyeCareThemes = {
      sepia: {
        name: 'æŠ¤çœ¼é»„',
        bg: 'rgba(255, 248, 220, 0.8)',
        text: '#5D4037',
        description: 'ç»å…¸æŠ¤çœ¼é…è‰²ï¼Œå‡å°‘è“å…‰åˆºæ¿€'
      },
      green: {
        name: 'æŠ¤çœ¼ç»¿',
        bg: 'rgba(232, 245, 233, 0.8)',
        text: '#2E7D32',
        description: 'ç»¿è‰²è°ƒæŠ¤çœ¼ï¼Œç¼“è§£çœ¼éƒ¨ç–²åŠ³'
      },
      blue: {
        name: 'æŠ¤çœ¼è“',
        bg: 'rgba(227, 242, 253, 0.8)',
        text: '#1565C0',
        description: 'è“è‰²è°ƒæŠ¤çœ¼ï¼Œé€‚åˆé•¿æ—¶é—´é˜…è¯»'
      },
      warm: {
        name: 'æš–å…‰',
        bg: 'rgba(255, 244, 229, 0.8)',
        text: '#8D6E63',
        description: 'æš–å…‰æ¨¡å¼ï¼Œå¤œé—´é˜…è¯»é¦–é€‰'
      }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      initSplashScreen();
    });

    function initSplashScreen() {
      const splashScreen = document.getElementById('splashScreen');
      const splashDots = document.getElementById('splashDots');
      for (let i = 0; i < 20; i++) {
        const dot = document.createElement('div');
        dot.className = 'absolute animate-ping';
        dot.style.left = `${Math.random() * 100}%`;
        dot.style.top = `${Math.random() * 100}%`;
        dot.style.animationDelay = `${Math.random() * 2}s`;
        dot.style.animationDuration = `${2 + Math.random() * 2}s`;
        dot.innerHTML = '<div class="w-2 h-2 bg-white/20 rounded-full"></div>';
        splashDots.appendChild(dot);
      }
      splashScreen.classList.remove('hidden');
      setTimeout(() => {
        showSplash = false;
        splashScreen.classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        initApp();
      }, 3000);
    }

    function initApp() {
      updateTheme();
      renderNavBar();
      renderMainContent();
      renderProgressBar();
      renderMenu();
      renderSettings();
      setupEventListeners();
      startReadingTimer();
    }

    function updateTheme() {
      const body = document.body;
      body.className = `min-h-screen ${isDarkMode ? 'bg-gray-900 text-gray-100' : 'bg-gray-50 text-gray-900'} transition-colors duration-300`;
      if (eyeCareMode) {
        const theme = eyeCareThemes[backgroundTint];
        const intensity = eyeCareIntensity / 100;
        body.style.backgroundColor = theme.bg.replace('0.8', `${0.3 + (intensity * 0.5)}`);
        body.style.color = theme.text;
        body.style.filter = `sepia(${intensity * 20}%) brightness(${100 - (intensity * 10)}%)`;
      } else {
        body.style.backgroundColor = '';
        body.style.color = '';
        body.style.filter = '';
      }
      renderNavBar();
      renderMainContent();
      renderProgressBar();
    }

    function renderNavBar() {
      const nav = document.getElementById('topNav');
      nav.className = `${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-b px-4 py-3 flex items-center justify-between sticky top-0 z-10`;
      if (eyeCareMode) {
        const theme = eyeCareThemes[backgroundTint];
        const intensity = eyeCareIntensity / 100;
        nav.style.backgroundColor = theme.bg.replace('0.8', `${0.3 + (intensity * 0.5)}`);
        nav.style.color = theme.text;
      } else {
        nav.style.backgroundColor = '';
        nav.style.color = '';
      }
      nav.innerHTML = `
        <div class="flex items-center space-x-3">
          <i data-lucide="book" class="w-6 h-6 text-blue-500"></i>
          <span class="font-medium truncate max-w-48">${fileName || 'æ™ºèƒ½æŠ¤çœ¼é˜…è¯»å™¨'}</span>
          ${eyeCareMode ? '<div class="flex items-center space-x-1 text-green-600"><i data-lucide="eye" class="w-4 h-4"></i><span class="text-xs">æŠ¤çœ¼æ¨¡å¼</span></div>' : ''}
        </div>
        <div class="flex items-center space-x-2">
          ${content && autoBreakReminder ? `<div class="flex items-center space-x-1 text-sm"><i data-lucide="timer" class="w-4 h-4"></i><span>${formatReadingTime(readingTime)}</span></div>` : ''}
          <button id="toggleEyeCare" class="p-2 rounded-lg ${eyeCareMode ? 'bg-green-100 text-green-600' : isDarkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} transition-colors">
            <i data-lucide="${eyeCareMode ? 'eye' : 'eye-off'}" class="w-5 h-5"></i>
          </button>
          <button id="toggleMenu" class="p-2 rounded-lg ${isDarkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} transition-colors">
            <i data-lucide="menu" class="w-5 h-5"></i>
          </button>
          <button id="toggleSettings" class="p-2 rounded-lg ${isDarkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} transition-colors">
            <i data-lucide="settings" class="w-5 h-5"></i>
          </button>
        </div>
      `;
      lucide.createIcons();
    }

    function renderMainContent() {
      const mainContent = document.getElementById('mainContent');
      if (!content) {
        mainContent.innerHTML = `
          <div class="flex flex-col items-center justify-center h-96 p-8">
            <div class="relative mb-6">
              <i data-lucide="file-text" class="w-16 h-16 text-gray-400"></i>
              ${eyeCareMode ? '<div class="absolute -top-1 -right-1"><i data-lucide="eye" class="w-6 h-6 text-green-500"></i></div>' : ''}
            </div>
            <h2 class="text-xl font-medium mb-2">æ¬¢è¿ä½¿ç”¨æ™ºèƒ½æŠ¤çœ¼é˜…è¯»å™¨</h2>
            <p class="text-gray-500 text-center mb-6">
              ${eyeCareMode ? 'æŠ¤çœ¼æ¨¡å¼å·²å¼€å¯ï¼Œä¸ºæ‚¨æä¾›èˆ’é€‚çš„é˜…è¯»ä½“éªŒ' : 'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸Šä¼ æ–‡æœ¬æ–‡ä»¶å¼€å§‹é˜…è¯»'}
            </p>
            <button id="uploadFileBtn" class="flex items-center space-x-2 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
              <i data-lucide="upload" class="w-5 h-5"></i>
              <span>é€‰æ‹©æ–‡ä»¶</span>
            </button>
            <div class="mt-6 text-center">
              <p class="text-sm text-gray-400 mb-2">æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼š</p>
              <div class="flex flex-wrap justify-center gap-2">
                ${['.txt', '.md', '.json', '.rtf'].map(format => `<span class="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded text-xs">${format}</span>`).join('')}
              </div>
            </div>
          </div>
        `;
      } else {
        mainContent.innerHTML = `
          <div id="contentArea" class="p-6 h-screen overflow-y-auto pb-32" style="font-size: ${fontSize}px; line-height: ${lineHeight}; font-family: ${getFontFamily()}; ${eyeCareMode ? `background-color: ${eyeCareThemes[backgroundTint].bg.replace('0.8', `${0.3 + (eyeCareIntensity / 100 * 0.5)}`)}; color: ${eyeCareThemes[backgroundTint].text}; filter: sepia(${eyeCareIntensity / 100 * 20}%); brightness(${100 - (eyeCareIntensity / 100 * 10)}%);` : ''}">
            <div class="max-w-4xl mx-auto">
              <pre class="whitespace-pre-wrap break-words">${content}</pre>
            </div>
          </div>
        `;
      }
      lucide.createIcons();
      setupFileUploadListeners();
      setupScrollListener();
    }

    function renderProgressBar() {
      const progressBar = document.getElementById('progressBar');
      if (content) {
        progressBar.classList.remove('hidden');
        if (eyeCareMode) {
          const theme = eyeCareThemes[backgroundTint];
          const intensity = eyeCareIntensity / 100;
          progressBar.style.backgroundColor = theme.bg.replace('0.8', `${0.3 + (intensity * 0.5)}`);
          progressBar.style.color = theme.text;
        } else {
          progressBar.style.backgroundColor = '';
          progressBar.style.color = '';
        }
        document.getElementById('progressPercent').textContent = `${readingProgress}%`;
        document.getElementById('progressFill').style.width = `${readingProgress}%`;
      } else {
        progressBar.classList.add('hidden');
      }
    }

    function renderMenu() {
      const menu = document.getElementById('sideMenu');
      menu.classList.toggle('hidden', !showMenu);
      const menuContent = document.getElementById('menuContent');
      menuContent.innerHTML = `
        <button id="menuUploadFile" class="w-full flex items-center space-x-3 p-3 rounded-lg ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'} transition-colors">
          <i data-lucide="upload" class="w-5 h-5"></i>
          <span>ä¸Šä¼ æ–‡ä»¶</span>
        </button>
        ${content ? `
          <button id="addBookmark" class="w-full flex items-center space-x-3 p-3 rounded-lg ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'} transition-colors">
            <i data-lucide="bookmark" class="w-5 h-5"></i>
            <span>æ·»åŠ ä¹¦ç­¾</span>
          </button>
          <button id="resetReading" class="w-full flex items-center space-x-3 p-3 rounded-lg ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'} transition-colors">
            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
            <span>é‡æ–°å¼€å§‹</span>
          </button>
        ` : ''}
        ${bookmarks.length > 0 ? `
          <div>
            <h4 class="font-medium mb-2">ä¹¦ç­¾</h4>
            <div class="space-y-2 max-h-64 overflow-y-auto">
              ${bookmarks.map(bookmark => `
                <div class="p-2 rounded ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}">
                  <div class="flex items-center justify-between">
                    <button class="go-to-bookmark flex-1 text-left" data-id="${bookmark.id}">
                      <div class="text-sm">è¿›åº¦: ${bookmark.progress}%</div>
                      <div class="text-xs opacity-70">${bookmark.timestamp}</div>
                    </button>
                    <button class="remove-bookmark text-red-500 hover:text-red-700 ml-2" data-id="${bookmark.id}">Ã—</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `;
      lucide.createIcons();
      setupFileUploadListeners();
    }

    function renderSettings() {
      const settings = document.getElementById('settingsPanel');
      settings.classList.toggle('hidden', !showSettings);
      const settingsContent = document.getElementById('settingsContent');
      settingsContent.innerHTML = `
        <div class="border-b pb-4">
          <h4 class="font-medium mb-3 flex items-center">
            <i data-lucide="shield" class="w-4 h-4 mr-2"></i>
            æŠ¤çœ¼åŠŸèƒ½
          </h4>
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm">æŠ¤çœ¼æ¨¡å¼</span>
              <button id="toggleEyeCareSwitch" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${eyeCareMode ? 'bg-green-600' : 'bg-gray-300'}">
                <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${eyeCareMode ? 'translate-x-6' : 'translate-x-1'}"></span>
              </button>
            </div>
            <p class="text-xs text-gray-500">å‡å°‘è“å…‰ï¼Œä¿æŠ¤çœ¼ç›</p>
          </div>
          ${eyeCareMode ? `
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">æŠ¤çœ¼å¼ºåº¦: ${eyeCareIntensity}%</label>
              <input id="eyeCareIntensity" type="range" min="10" max="100" value="${eyeCareIntensity}" class="w-full">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">æŠ¤çœ¼é…è‰²</label>
              <div class="grid grid-cols-2 gap-2">
                ${Object.entries(eyeCareThemes).map(([key, theme]) => `
                  <button class="set-background-tint p-2 rounded-lg text-xs ${backgroundTint === key ? 'ring-2 ring-blue-500' : ''} transition-all" data-tint="${key}" style="background-color: ${theme.bg}; color: ${theme.text}">
                    ${theme.name}
                  </button>
                `).join('')}
              </div>
            </div>
          ` : ''}
          <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm">ä¼‘æ¯æé†’</span>
              <button id="toggleBreakReminder" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${autoBreakReminder ? 'bg-blue-600' : 'bg-gray-300'}">
                <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${autoBreakReminder ? 'translate-x-6' : 'translate-x-1'}"></span>
              </button>
            </div>
            <p class="text-xs text-gray-500">å®šæ—¶æé†’ä¼‘æ¯ï¼Œä¿æŠ¤è§†åŠ›</p>
          </div>
          ${autoBreakReminder ? `
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">æé†’é—´éš”: ${breakInterval} åˆ†é’Ÿ</label>
              <input id="breakInterval" type="range" min="10" max="60" step="5" value="${breakInterval}" class="w-full">
              <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>10åˆ†é’Ÿ</span>
                <span>60åˆ†é’Ÿ</span>
              </div>
            </div>
          ` : ''}
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">ä¸»é¢˜</label>
          <button id="toggleTheme" class="flex items-center space-x-3 p-3 rounded-lg w-full ${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'} transition-colors">
            <i data-lucide="${isDarkMode ? 'moon' : 'sun'}" class="w-5 h-5"></i>
            <span>${isDarkMode ? 'æ·±è‰²æ¨¡å¼' : 'æµ…è‰²æ¨¡å¼'}</span>
          </button>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">å­—ä½“</label>
          <select id="fontSelect" class="w-full p-2 rounded-lg border ${isDarkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}">
            ${fontOptions.map(option => `<option value="${option.value}" ${font === option.value ? 'selected' : ''}>${option.label}</option>`).join('')}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">å­—ä½“å¤§å°: ${fontSize}px</label>
          <div class="flex items-center space-x-4">
            <button id="decreaseFont" class="p-2 rounded-lg ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'} transition-colors">
              <i data-lucide="minus" class="w-4 h-4"></i>
            </button>
            <div class="flex-1">
              <input id="fontSizeRange" type="range" min="12" max="24" value="${fontSize}" class="w-full">
            </div>
            <button id="increaseFont" class="p-2 rounded-lg ${isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'} transition-colors">
              <i data-lucide="plus" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">è¡Œé—´è·: ${lineHeight}</label>
          <input id="lineHeightRange" type="range" min="1.2" max="2.5" step="0.1" value="${lineHeight}" class="w-full">
        </div>
        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
          <h5 class="font-medium mb-2 flex items-center text-blue-700 dark:text-blue-300">
            <i data-lucide="eye" class="w-4 h-4 mr-2"></i>
            æŠ¤çœ¼å°è´´å£«
          </h5>
          <ul class="text-xs space-y-1 text-blue-600 dark:text-blue-400">
            <li>â€¢ æ¯20åˆ†é’Ÿè¿œçœº20è‹±å°ºå¤–20ç§’</li>
            <li>â€¢ ä¿æŒé€‚å½“çš„é˜…è¯»è·ç¦»</li>
            <li>â€¢ è°ƒèŠ‚å±å¹•äº®åº¦ä¸ç¯å¢ƒåè°ƒ</li>
            <li>â€¢ å¤šçœ¨çœ¼ä¿æŒçœ¼éƒ¨æ¹¿æ¶¦</li>
          </ul>
        </div>
      `;
      lucide.createIcons();
      setupSettingsEventListeners();
    }

    function renderBreakReminder() {
      const modal = document.getElementById('breakReminderModal');
      modal.classList.toggle('hidden', !showBreakReminder);
      document.getElementById('breakReminderText').textContent = `æ‚¨å·²ç»è¿ç»­é˜…è¯»äº† ${breakInterval} åˆ†é’Ÿï¼Œå»ºè®®ä¼‘æ¯ä¸€ä¸‹ï¼Œè¿œçœºæˆ–åšçœ¼ä¿å¥æ“ã€‚`;
      lucide.createIcons();
    }

    function setupEventListeners() {
      document.getElementById('topNav').addEventListener('click', (e) => {
        if (e.target.closest('#toggleEyeCare') || e.target.id === 'toggleEyeCare') {
          eyeCareMode = !eyeCareMode;
          updateTheme();
          renderNavBar();
          renderMainContent();
          renderProgressBar();
          renderSettings();
        }
        if (e.target.closest('#toggleMenu') || e.target.id === 'toggleMenu') {
          showMenu = !showMenu;
          renderMenu();
        }
        if (e.target.closest('#toggleSettings') || e.target.id === 'toggleSettings') {
          showSettings = !showSettings;
          renderSettings();
        }
      });
      document.getElementById('toggleEyeCareSwitch')?.addEventListener('click', () => {
        eyeCareMode = !eyeCareMode;
        updateTheme();
        renderNavBar();
        renderMainContent();
        renderProgressBar();
        renderSettings();
      });
      document.getElementById('closeMenu')?.addEventListener('click', () => {
        showMenu = false;
        renderMenu();
      });
      document.getElementById('menuOverlay')?.addEventListener('click', () => {
        showMenu = false;
        renderMenu();
      });
      document.getElementById('closeSettings')?.addEventListener('click', () => {
        showSettings = false;
        renderSettings();
      });
      document.getElementById('settingsOverlay')?.addEventListener('click', () => {
        showSettings = false;
        renderSettings();
      });
      document.getElementById('addBookmark')?.addEventListener('click', addBookmark);
      document.getElementById('resetReading')?.addEventListener('click', resetReading);
    }

    function setupFileUploadListeners() {
      const fileInput = document.getElementById('fileInput');
      const uploadFileBtn = document.getElementById('uploadFileBtn');
      const menuUploadFile = document.getElementById('menuUploadFile');

      fileInput?.addEventListener('change', handleFileUpload);
      uploadFileBtn?.addEventListener('click', () => fileInput.click());
      menuUploadFile?.addEventListener('click', () => fileInput.click());
    }

    function setupSettingsEventListeners() {
      document.getElementById('toggleTheme')?.addEventListener('click', () => {
        isDarkMode = !isDarkMode;
        updateTheme();
        renderNavBar();
        renderMainContent();
        renderMenu();
        renderSettings();
      });
      document.getElementById('fontSelect')?.addEventListener('change', (e) => {
        font = e.target.value;
        renderMainContent();
        renderSettings();
      });
      document.getElementById('fontSizeRange')?.addEventListener('input', (e) => {
        fontSize = parseInt(e.target.value);
        renderMainContent();
        renderSettings();
      });
      document.getElementById('decreaseFont')?.addEventListener('click', () => {
        fontSize = Math.max(12, fontSize - 2);
        renderMainContent();
        renderSettings();
      });
      document.getElementById('increaseFont')?.addEventListener('click', () => {
        fontSize = Math.min(24, fontSize + 2);
        renderMainContent();
        renderSettings();
      });
      document.getElementById('lineHeightRange')?.addEventListener('input', (e) => {
        lineHeight = parseFloat(e.target.value);
        renderMainContent();
        renderSettings();
      });
      document.getElementById('eyeCareIntensity')?.addEventListener('input', (e) => {
        eyeCareIntensity = parseInt(e.target.value);
        updateTheme();
        renderMainContent();
        renderNavBar();
        renderProgressBar();
        renderSettings();
      });
      document.getElementById('toggleBreakReminder')?.addEventListener('click', () => {
        autoBreakReminder = !autoBreakReminder;
        startReadingTimer();
        renderSettings();
      });
      document.getElementById('breakInterval')?.addEventListener('input', (e) => {
        breakInterval = parseInt(e.target.value);
        renderSettings();
      });
      document.getElementById('acknowledgeBreak')?.addEventListener('click', () => {
        showBreakReminder = false;
        readingTime = 0;
        renderBreakReminder();
      });
      document.getElementById('disableBreakReminder')?.addEventListener('click', () => {
        autoBreakReminder = false;
        showBreakReminder = false;
        renderBreakReminder();
        renderSettings();
      });
      document.querySelectorAll('.set-background-tint')?.forEach(btn => {
        btn.addEventListener('click', (e) => {
          backgroundTint = e.target.dataset.tint;
          updateTheme();
          renderMainContent();
          renderNavBar();
          renderProgressBar();
          renderSettings();
        });
      });
      document.querySelectorAll('.go-to-bookmark')?.forEach(btn => {
        btn.addEventListener('click', () => {
          const bookmark = bookmarks.find(b => b.id === parseInt(btn.dataset.id));
          if (bookmark && document.getElementById('contentArea')) {
            document.getElementById('contentArea').scrollTop = bookmark.position;
            showMenu = false;
            renderMenu();
          }
        });
      });
      document.querySelectorAll('.remove-bookmark')?.forEach(btn => {
        btn.addEventListener('click', () => {
          bookmarks = bookmarks.filter(b => b.id !== parseInt(btn.dataset.id));
          renderMenu();
        });
      });
    }

    function setupScrollListener() {
      const contentArea = document.getElementById('contentArea');
      if (contentArea) {
        contentArea.addEventListener('scroll', handleScroll);
      }
    }

    function handleScroll() {
      const contentArea = document.getElementById('contentArea');
      if (contentArea) {
        const scrollTop = contentArea.scrollTop;
        const scrollHeight = contentArea.scrollHeight - contentArea.clientHeight;
        readingProgress = scrollHeight > 0 ? Math.round((scrollTop / scrollHeight) * 100) : 0;
        currentPosition = scrollTop;
        renderProgressBar();
      }
    }

    function detectEncoding(bytes) {
      if (bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF) return 'utf-8';
      if ((bytes[0] === 0xFF && bytes[1] === 0xFE) || (bytes[0] === 0xFE && bytes[1] === 0xFF)) return 'utf-16';
      let gbkCount = 0, utf8Count = 0;
      for (let i = 0; i < Math.min(bytes.length, 1000); i++) {
        const byte = bytes[i];
        if (byte >= 0xA1 && byte <= 0xFE && i + 1 < bytes.length && bytes[i + 1] >= 0xA1 && bytes[i + 1] <= 0xFE) {
          gbkCount++;
          i++;
        }
        if ((byte >= 0xC0 && byte <= 0xDF && i + 1 < bytes.length && bytes[i + 1] >= 0x80 && bytes[i + 1] <= 0xBF) ||
            (byte >= 0xE0 && byte <= 0xEF && i + 2 < bytes.length && bytes[i + 1] >= 0x80 && bytes[i + 1] <= 0xBF && bytes[i + 2] >= 0x80 && bytes[i + 2] <= 0xBF)) {
          utf8Count++;
          i += (byte >= 0xE0 ? 2 : 1);
        }
      }
      return utf8Count > gbkCount ? 'utf-8' : gbkCount > 0 ? 'gbk' : 'utf-8';
    }

    async function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      try {
        const arrayBuffer = await file.arrayBuffer();
        const bytes = new Uint8Array(arrayBuffer);
        const encoding = detectEncoding(bytes);
        let text;
        if (encoding === 'gbk') {
          try {
            text = new TextDecoder('gbk').decode(bytes);
          } catch (e) {
            try {
              text = new TextDecoder('gb2312').decode(bytes);
            } catch {
              text = new TextDecoder('utf-8').decode(bytes);
            }
          }
        } else {
          text = new TextDecoder(encoding).decode(bytes);
        }
        if (text.includes('ï¿½')) {
          const encodings = ['utf-8', 'gb2312', 'big5', 'shift-jis'];
          for (const enc of encodings) {
            try {
              const testText = new TextDecoder(enc).decode(bytes);
              if (!testText.includes('ï¿½')) {
                text = testText;
                break;
              }
            } catch {}
          }
        }
        content = text;
        fileName = file.name;
        currentPosition = 0;
        readingProgress = 0;
        readingTime = 0;
        const contentArea = document.getElementById('contentArea');
        if (contentArea) contentArea.scrollTop = 0;
        renderMainContent();
        renderNavBar();
        renderMenu();
        renderProgressBar();
        startReadingTimer();
      } catch (error) {
        alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç¼–ç æ ¼å¼ä¸æ”¯æŒã€‚è¯·å°è¯•å°†æ–‡ä»¶ä¿å­˜ä¸º UTF-8 æ ¼å¼ã€‚');
        console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', error);
      }
    }

    function addBookmark() {
      const bookmark = {
        id: Date.now(),
        position: currentPosition,
        progress: readingProgress,
        timestamp: new Date().toLocaleString()
      };
      bookmarks.push(bookmark);
      renderMenu();
    }

    function resetReading() {
      const contentArea = document.getElementById('contentArea');
      if (contentArea) contentArea.scrollTop = 0;
      currentPosition = 0;
      readingProgress = 0;
      readingTime = 0;
      renderMainContent();
      renderProgressBar();
    }

    function formatReadingTime(seconds) {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return hours > 0 ? 
        `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}` :
        `${minutes}:${secs.toString().padStart(2, '0')}`;
    }

    function getFontFamily() {
      switch (font) {
        case 'serif': return 'Georgia, serif';
        case 'sans-serif': return 'Arial, sans-serif';
        case 'monospace': return 'Courier New, monospace';
        default: return 'system-ui, -apple-system, sans-serif';
      }
    }

    function startReadingTimer() {
      if (readingTimer) clearInterval(readingTimer);
      if (content && autoBreakReminder) {
        readingTimer = setInterval(() => {
          readingTime++;
          if (readingTime % (breakInterval * 60) === 0) {
            showBreakReminder = true;
            renderBreakReminder();
          }
          renderNavBar();
        }, 1000);
      }
    }
  </script>
</body>
</html>
